---
title: "EDLD651_final_project"
author: "Kyla & Erika & Cheyna"
format: pdf
editor: visual
---

<<<<<<< Updated upstream
# Load Packages

=======
>>>>>>> Stashed changes

```{r}
library(here)
library(janitor)
library(rio)
library(tidyverse)
library(tm)
library(dplyr)
#install.packages("tm") <- i didn't have this package
```

# Import Data

<<<<<<< Updated upstream
```{r}
# Fruit data

fruit_files <- list.files(pattern = ".xlsx", path = "../data/fruit-2020", full.names = TRUE)

fruit_2020 <- do.call(rbind, lapply
        (fruit_files, import, as.is=T, header = FALSE))

# Vegetable Data
veg_files <- list.files(pattern = ".xlsx", path = "../data/vegetables-2020", full.names = TRUE)

veg_2020 <- do.call(rbind, lapply
        (veg_files, import, as.is=T, header = FALSE))
```

# Removing rows without data

```{r}
# Fruit cleaning
fruit_2020 <- fruit_2020 %>% # rename cols to be more descriptive
  rename(fruit = ...1, retail_price = ...2, retail_price_unit = ...3, yield = ...4, cup_eq_size = ...5, cup_eq_unit = ...6,cup_eq_price = ...7)

fruit_2020_clean <- fruit_2020 %>% # remove rows without data (these were just the citation of where the data came from)
  filter(!substr(fruit, 1, 1) == "1") %>% 
  filter(!substr(fruit, 1, 1) == "2") %>% 
  filter(!substr(fruit, 1, 1) == "3") %>% 
  filter(!substr(fruit, 1, 1) == "4") %>% 
  filter(!substr(fruit, 1, 6) == "Source")

# Veggie cleaning
veg_2020 <- veg_2020 %>% # rename cols to be more descriptive
  rename(veg = ...1, retail_price = ...2, retail_price_unit = ...3, yield = ...4, cup_eq_size = ...5, cup_eq_unit = ...6,cup_eq_price = ...7)

veg_2020_clean <- veg_2020 %>% # remove rows without data (these were just the citation of where the data came from)
  filter(!substr(veg, 1, 1) == "1") %>% 
  filter(!substr(veg, 1, 1) == "2") %>% 
  filter(!substr(veg, 1, 1) == "3") %>% 
  filter(!substr(veg, 1, 1) == "4") %>% 
  filter(!substr(veg, 1, 6) == "Source")
```

# Tidying the data

```{r}
# Fruit
fruit_names <- c("Apples", "Apricots", "Bananas", "Mixed berries", "Blackberries", "Blueberries", "Cantaloupe", "Cherries", "Clementines", "Cranberries", "Dates", "Figs", "Fruit cocktail", "Grapefruit", "Grapes", "Honeydew melon", "Kiwi", "Mangoes", "Nectarines", "Oranges", "Papaya", "Peaches", "Pears", "Pineapple", "Plums", "Pomegranate", "Raspberries", "Strawberries", "Watermelon") # creating a vector with the fruit names

fruit_2020_clean <- fruit_2020_clean |> 
  # fix the fruit column to isolate the fruit name
  mutate(fruit = str_extract(fruit, "[^—]+")) |> 
  # create a flag for fruit names
  mutate(is_fruit = fruit %in% fruit_names) |> 
  # fill the fruit name down
  mutate(fruit_name = if_else(is_fruit, fruit, NA_character_)) |> 
  fill(fruit_name, .direction = "down") |> 
  # remove rows where fruit column is the fruit name or "Form"
  filter(!is_fruit, fruit != "Form") |> 
  # rename columns
  rename(form = fruit) |> 
  # move the fruit column to the beginning
  relocate(fruit_name, .before = "form") |> 
  # remove the is_fruit column, we don't need it anymore
  select(-is_fruit) |> 
  # remove any rows with NA in the retail_price column
  filter(!is.na(retail_price))

# Vegetable
veg_names <- c("Acorn squash", "Artichoke", "Asparagus", "Avocados", "Beets", "Black beans", "Blackeye peas", "Broccoli", "Brussels sprouts", "Butternut squash", "Cabbage", "Carrots", "Cauliflower", "Celery", "Collard greens", "Sweet corn", "Cucumbers", "Great northern beans", "Green beans", "Green peas", "Green peppers", "Kale", "Kidney beans", "Lentils", "Iceberg lettuce", "Romaine lettuce", "Lima beans", "Mixed vegetables", "Mushrooms", "Mustard greens", "Navy beans", "Okra", "Olives", "Onions", "Pinto beans", "Potatoes", "Pumpkin", "Radish", "Red peppers", "Spinach", "Sweet potatoes", "Tomatoes", "Turnip greens", "Zucchini") # creating a vector with the veggie names

veg_2020_clean <- veg_2020_clean |> 
  # fix the veg column to isolate the veg name
  mutate(veg = str_extract(veg, "[^—]+")) |> 
  # create a flag for veg names
  mutate(is_veg = veg %in% veg_names) |> 
  # fill the veg name down
  mutate(veg_name = if_else(is_veg, veg, NA_character_)) |> 
  fill(veg_name, .direction = "down") |> 
  # remove rows where veg column is the veg name or "Form"
  filter(!is_veg, veg != "Form") |> 
  # rename columns
  rename(form = veg) |> 
  # move the veg column to the beginning
  relocate(veg_name, .before = "form") |> 
  # remove the is_veg column, we don't need it anymore
  select(-is_veg) |> 
  # remove any rows with NA in the reatil_price column
  filter(!is.na(retail_price))
```

# How does the price of fruits and vegetables vary based on form? (Kyla)

```{r}
# remove the numbers at the end of the forms
fruit_2020_clean$form <- removeNumbers(fruit_2020_clean$form)
veg_2020_clean$form <- removeNumbers(veg_2020_clean$form)

# remove additional specifiers from form column that are not important
fruit_2020_clean$form <- gsub("\\s*\\([^\\)]+\\)", "", fruit_2020_clean$form)
fruit_2020_clean$form <- sub(",.*", "", fruit_2020_clean$form)
veg_2020_clean$form <- sub(" .*$", "", veg_2020_clean$form)
veg_2020_clean$form <- gsub(",", "", veg_2020_clean$form)

# change the tomato forms from "Grape", "Roma", and "Large to all be "Fresh"
# and filter to only look at price differences between fresh, frozen, canned, and dried
veg_2020_clean <- veg_2020_clean |> 
  mutate(form = case_when(form == "Canned" ~ "Canned",
                   form == "Grape" ~ "Fresh", 
                   form == "Roma" ~ "Fresh", 
                   form == "Large" ~ "Fresh",
                   TRUE ~ form)) |> 
  filter(form == "Fresh" | form == "Frozen" | form == "Canned" | form == "Dried")

# remove the specific rows for raisins and applesauce because they don't fit cleanly into a category
# and change "Ready to drink" to "Juice"
fruit_2020_clean <- fruit_2020_clean |> 
  filter(form != "Raisins" & form != "Applesauce") |> 
  mutate(form = case_when(form == "Ready to drink" ~ "Juice",
                          TRUE ~ form))

# make sure retail_price is a numeric variable
fruit_2020_clean <- fruit_2020_clean |> 
  mutate(retail_price = as.numeric(retail_price))
veg_2020_clean <- veg_2020_clean |> 
  mutate(retail_price = as.numeric(retail_price))

# examine retail price by form
fruit_summary <- fruit_2020_clean |> 
  group_by(form) |> 
  summarize(mean_retail_price = mean(retail_price, na.rm = TRUE))
veg_summary <- veg_2020_clean |> 
  group_by(form) |> 
  summarize(mean_retail_price = mean(retail_price, na.rm = TRUE))
```

```{r}
fruit_summary |> 
  ggplot(aes(x = form, y = mean_retail_price, fill = form)) +
  geom_bar(stat = "identity") +
  labs(title = "Average Fruit Retail Prices by Form",
       x = "Form",
       y = "Average Retail Price") +
  scale_fill_manual(values = c("#005f73", "#0a9396", "#94d2bd", "#e9d8a6", "#ee9b00", "#ca6702", "#bb3e03")) +
  theme(theme_minimal(),
        legend.position = "NULL",
        axis.text.x = element_text(angle = 45, hjust = 1))

veg_summary |> 
  ggplot(aes(x = form, y = mean_retail_price, fill = form)) +
  geom_bar(stat = "identity") +
  labs(title = "Average Vegetable Retail Prices by Form",
       x = "Form",
       y = "Average Retail Price") +
  scale_fill_manual(values = c("#005f73", "#0a9396", "#94d2bd", "#e9d8a6", "#ee9b00", "#ca6702", "#bb3e03")) +
  theme(theme_minimal(),
        legend.position = "NULL",
        axis.text.x = element_text(angle = 45, hjust = 1))
```


# Do fruit and vegetable prices vary by family (berries, stone fruit etc)? (Erika)

```{r}
#making a new column for the fruit groups -- I can add where I found this info in our introduction :P

fruit_family_data <- fruit_2020_clean %>%
   mutate(
    family = case_when(
      fruit_name %in% c("Peaches", "Plums", "Apricots", "Cherries",
                        "Nectarines", "Mangoes", "Dates") ~ "stone fruit",
      
      fruit_name %in% c("Blackberries", "Blueberries", "Raspberries",
                        "Strawberries", "Pomegranate", "Bananas", "Kiwi",
                        "Pineapple", "Cranberries", "Grapes", "Papaya") ~ "berries",
      
      fruit_name %in% c("Apples", "Pears") ~ "pome",
      
      fruit_name %in% c("Clementines", "Oranges", "Grapefruit") ~ "citrus",
      
      fruit_name %in% c("Cantaloupe", "Honeydew melon", "Watermelon") ~ "melon",
      
      fruit_name %in% c("Mixed berries", "Fruit cocktail") ~ "mixed fruits",
      
      fruit_name %in% c("Figs") ~ "syconium",
      
      TRUE ~ "other"
    )
  )

#looking at summary stats by family ... using cup eq. price so we have a relatively similar amount by price
str(fruit_family_data$cup_eq_price)
fruit_family_data <- fruit_family_data %>% 
  mutate(cup_eq_price = as.numeric(cup_eq_price))

fruit_family_data %>%
  group_by(family) %>%
  summarize(
    mean_price = mean(cup_eq_price, na.rm = TRUE),
    median_price = median(cup_eq_price, na.rm = TRUE),
    sd_price = sd(cup_eq_price, na.rm = TRUE),
    n = n()
  )

# running a one way anova to see if price (continuous) varies by family (categorical). I found that it does not vary signifiantly (p = .158)
anova_result <- aov(cup_eq_price ~ family, data = fruit_family_data)
summary(anova_result)

#plot
plot_table1 <- fruit_family_data %>%
  group_by(family) %>%
  summarize(
    mean_price = mean(cup_eq_price, na.rm = TRUE),
    sd_price = sd(cup_eq_price, na.rm = TRUE),
    n = n(),
    se_price = sd_price / sqrt(n)
  )

ggplot(plot_table1, aes(x = reorder(family, mean_price), y = mean_price)) +
  geom_col(fill = "deeppink4") +
  geom_errorbar(aes(ymin = mean_price - se_price, ymax = mean_price + se_price), width = 0.3) +
  labs(x = "Fruit Family", y = "Mean Price per Unit", title = "Mean Fruit Prices by Family") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
```{r}
# doing the same exact thing but for vegetables 
veg_family_data <- veg_2020_clean %>%
   mutate(
    family = case_when(
      veg_name %in% c("Broccoli", "Brussels sprouts", "Cabbage", "Cauliflower",
                        "Collard greens", "Kale", "Turnip greens", "Radish", "Mustard greens") ~ "cabbage family",
      
      veg_name %in% c("Carrots", "Celery") ~ "carrot family",
      
      veg_name %in% c("Onions", "Asparagus") ~ "liliceae family",
      
      veg_name %in% c("Acorn squash", "Cucumbers", "Butternut squash", "Pumpkin", "Zucchini") ~ "gourd family",
      
      veg_name %in% c("Black beans", "Blackeye peas", "Great northern beans", "Green beans", "Green peas", "Kidney beans", "Lima beans", "Navy beans", "Pinto beans", "Lentils") ~ "legume family",
      
      veg_name %in% c("Tomatoes", "Sweet potatoes", "Red peppers", "Potatoes", "Green peppers") ~ "nightshade family",
      
      veg_name %in% c("Okra") ~ "hibiscus family",
      
      veg_name %in% c("Sweet corn") ~ "grass family",
      
      veg_name %in% c("Artichoke", "Iceberg lettuce", "Romaine lettuce") ~ "aster family",
      
      veg_name %in% c("Spinach", "Beets") ~ "goosefoot family",
      
      veg_name %in% c("Avocados", "Olives") ~ "botanically considered a fruit",
      
      veg_name %in% c("Mushrooms") ~ "fungus",
      
      veg_name %in% c("Mixed vegetables") ~ "mixed",
      
      TRUE ~ "other"
    )
  )

str(veg_family_data$cup_eq_price)
veg_family_data <- veg_family_data %>% 
  mutate(cup_eq_price = as.numeric(cup_eq_price))

anova_result2 <- aov(cup_eq_price ~ family, data = veg_family_data)
summary(anova_result2) # this one DID have a significant difference (p < 0.001) so i did post-hoc to see what's going on. 

pairwise.t.test(veg_family_data$cup_eq_price, veg_family_data$family,
                p.adjust.method = "bonferroni")

#confusing to read but the significant groups are: liliceae is signnificantly different from aster, liliceae different from botanical fruits, liliceae different from gourd, liliceae different from carrot, liliceae different from legume, liliceae different from mixed, liliceae different from nightshade
#difference mostly because of liliceae (onions + asparagus) being higher in price than others 

# plot 
summary_table <- veg_family_data %>%
  group_by(family) %>%
  summarize(
    mean_price = mean(cup_eq_price, na.rm = TRUE),
    sd_price = sd(cup_eq_price, na.rm = TRUE),
    n = n(),
    se_price = sd_price / sqrt(n)
  )

ggplot(summary_table, aes(x = reorder(family, mean_price), y = mean_price)) +
  geom_col(fill = "olivedrab4") +
  geom_errorbar(aes(ymin = mean_price - se_price, ymax = mean_price + se_price), width = 0.3) +
  labs(x = "Vegetable Family", y = "Mean Price per Unit", title = "Mean Vegetable Prices by Family") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# What is the relationship between retail price and yield by form? (Cheyna)

```{r}

=======
veggie_data <- import(here("data", "Vegetable-Prices-2022.csv")) %>%  
  clean_names()
>>>>>>> Stashed changes
```
